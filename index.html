<!-- <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dynamic Weather & AI Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  /* CSS remains mostly the same, added loading state for chat */
  body{font-family:Poppins,sans-serif;min-height:100vh;margin:0;display:flex;justify-content:center;background:linear-gradient(135deg,#fceabb,#f8b500);}
  .page-container{position:absolute;max-width:360px;width:90%;opacity:0;pointer-events:none;transform:scale(.97);transition:.3s;}
  .page-container.active{opacity:1;pointer-events:auto;transform:scale(1);}
  .input-card{background:#fff;padding:30px;border-radius:20px;text-align:center;box-shadow:0 15px 30px rgba(0,0,0,.25);}
  #city-input{width:100%;padding:12px;border-radius:10px;border:1px solid #ddd;margin-bottom:15px;box-sizing: border-box;}
  #search-btn{width:100%;padding:12px;border:none;border-radius:10px;font-size:18px;color:white;background:#ff9966;cursor:pointer;}
  h2{color:white;text-align:center}
  #weather-icon{display:block;margin:auto;width:100px}
  #temperature{font-size:72px;color:white;text-align:center;}
  #feels-like,#description{text-align:center;color:#f1f1f1}
  #aqi-card{background:rgba(0,0,0,.35);border-radius:15px;padding:15px;margin:15px 0;color:white;}
  .aqi-bar{position:relative;height:8px;border-radius:10px;background:linear-gradient(90deg,#1e7f32,#7bc043,#fdd64b,#ff8a3d,#d32f2f);margin-top: 10px;}
  #aqi-dot{position:absolute;top:50%;width:14px;height:14px;background:white;border-radius:50%;transform:translate(-50%,-50%);transition: left 0.5s ease;}
  .data-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;padding:15px;border-radius:12px;background:rgba(0,0,0,.35);}
  .data-item span{font-size:12px;color:#ffd966}
  .data-item strong{font-size:17px;color:white}
  #back-btn{margin-top:20px;width:100%;padding:12px;border:none;border-radius:12px;background:#654321;color:white;cursor:pointer;}
  
  /* CHATBOT STYLES */
  #chatbot{position:fixed;bottom:20px;right:20px;width:280px;background:#111;border-radius:15px;color:white;overflow:hidden;font-size:13px;box-shadow: 0 10px 20px rgba(0,0,0,0.4); z-index: 100;}
  #chat-header{background:#ff9966;padding:10px;text-align:center;font-weight:600; display:flex; justify-content: space-between; align-items: center;}
  #chat-status { font-size: 10px; opacity: 0.8; }
  #chat-body{height:250px;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:8px;}
  .chat-msg{padding: 8px 12px; border-radius: 10px; max-width: 85%; line-height: 1.4;}
  .user-msg{align-self: flex-end; background: #444; color: #ffd966; border-bottom-right-radius: 2px;}
  .bot-msg{align-self: flex-start; background: #222; color: #90ee90; border-bottom-left-radius: 2px;}
  #chat-input-area{display:flex;border-top:1px solid #333;}
  #chat-input{flex:1;padding:12px;border:none;background: #222; color: white; outline: none;}
  #chat-send{background:#ff9966;border:none;color:white;padding:0 15px;cursor:pointer;font-weight: bold;}
  #chat-send:disabled { background: #555; cursor: not-allowed;}
</style>
</head>
<body>

<div id="input-page" class="page-container active">
  <div class="input-card">
    <h1>Dynamic Weather üå§Ô∏è</h1>
    <input id="city-input" placeholder="Enter city name (e.g., London)">
    <button id="search-btn">Show Weather</button>
  </div>
</div>

<div id="details-page" class="page-container">
  <h2 id="city-name"></h2>
  <img id="weather-icon" alt="Weather Icon">
  <div id="temperature"></div>
  <div id="feels-like"></div>
  <div id="description"></div>

  <div id="aqi-card">
    <div style="display:flex; justify-content:space-between;">
      <strong id="aqi-title">AQI</strong>
      <span id="aqi-message"></span>
    </div>
    <div class="aqi-bar"><div id="aqi-dot"></div></div>
  </div>

  <div class="data-grid">
    <div class="data-item"><span>HUMIDITY</span><strong id="humidity"></strong></div>
    <div class="data-item"><span>WIND</span><strong id="wind"></strong></div>
    <div class="data-item"><span>PRESSURE</span><strong id="pressure"></strong></div>
    <div class="data-item"><span>VISIBILITY</span><strong id="visibility"></strong></div>
  </div>

  <button id="back-btn">‚Üê New Search</button>
</div>

<div id="chatbot">
  <div id="chat-header">
    <span>ü§ñ Weather AI</span>
    <span id="chat-status">Ready</span>
  </div>
  <div id="chat-body">
    <div class="chat-msg bot-msg">Hello! Search for a city, then ask me anything about the weather there.</div>
  </div>
  <div id="chat-input-area">
    <input id="chat-input" placeholder="Ask Gemini..." />
    <button id="chat-send">‚û§</button>
  </div>
</div>

<script type="importmap">
  {
    "imports": {
      "@google/generative-ai": "https://esm.run/@google/generative-ai"
    }
  }
</script>

<script type="module">
import { GoogleGenerativeAI } from "@google/generative-ai";

// ================= CONFIGURATION =================
// ‚ö†Ô∏è WARNING: In a production app, never expose API keys in frontend code.
// For this local demo, replace "YOUR_GEMINI_KEY" below.
const GEMINI_API_KEY = "AIzaSyBywx-ar8EuFvCGZlC5q9UYDtaEPCmsiZs"; 
const OWM_API_KEY = "043aa3f3dfcc0cc451d7c3c8d2dab5a2"; // Your OWM Key

const WEATHER_URL = "https://api.openweathermap.org/data/2.5/weather";
const AQI_URL = "https://api.openweathermap.org/data/2.5/air_pollution";
const ICON_URL = "https://openweathermap.org/img/wn/";

// Initialize Gemini
let genAI, model;
try {
    genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
    model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
} catch (e) {
    console.error("Gemini Init Error: Missing Key?", e);
}

// State
let currentWeatherData = null;
let currentAqiData = null;

// Helper
const qs = id => document.getElementById(id);

// ================= WEATHER LOGIC =================
qs("search-btn").onclick = async () => {
    const city = qs("city-input").value.trim();
    if (!city) { alert("Please enter a city name"); return; }
    
    qs("search-btn").textContent = "Loading...";

    try {
        // 1. Fetch Weather
        const res = await fetch(`${WEATHER_URL}?q=${city}&appid=${OWM_API_KEY}&units=metric`);
        if (!res.ok) throw new Error("City not found");
        currentWeatherData = await res.json();

        // 2. Update UI
        updateWeatherUI(currentWeatherData);

        // 3. Fetch AQI
        const { lat, lon } = currentWeatherData.coord;
        const aqiRes = await fetch(`${AQI_URL}?lat=${lat}&lon=${lon}&appid=${OWM_API_KEY}`);
        const aqiData = await aqiRes.json();
        
        // Approx AQI calculation
        const pm25 = aqiData.list[0].components.pm2_5;
        currentAqiData = Math.min(Math.round(pm25 * 4), 500); 
        updateAqiUI(currentAqiData);

        // Transition Pages
        qs("input-page").classList.remove("active");
        qs("details-page").classList.add("active");
        
        // Reset Chat for new city
        addMsg(`I now have weather data for ${currentWeatherData.name}. Ask me should you go for a run, or what to wear!`, "bot");

    } catch (error) {
        alert(error.message);
    } finally {
        qs("search-btn").textContent = "Show Weather";
    }
};

function updateWeatherUI(data) {
    qs("city-name").textContent = data.name + ", " + data.sys.country;
    qs("weather-icon").src = `${ICON_URL}${data.weather[0].icon}@2x.png`;
    qs("temperature").textContent = Math.round(data.main.temp) + "¬∞C";
    qs("feels-like").textContent = `Feels like ${Math.round(data.main.feels_like)}¬∞C`;
    qs("description").textContent = data.weather[0].description.toUpperCase();
    qs("humidity").textContent = data.main.humidity + "%";
    qs("wind").textContent = data.wind.speed + " m/s";
    qs("pressure").textContent = data.main.pressure + " hPa";
    qs("visibility").textContent = (data.visibility / 1000).toFixed(1) + " km";
}

function updateAqiUI(aqi) {
    qs("aqi-title").textContent = "AQI " + aqi;
    qs("aqi-message").textContent = aqi > 100 ? "Unhealthy" : "Good";
    qs("aqi-dot").style.left = Math.min((aqi / 300) * 100, 100) + "%"; // Scale to 300 for visualization
}

qs("back-btn").onclick = () => {
    qs("details-page").classList.remove("active");
    qs("input-page").classList.add("active");
    qs("city-input").value = "";
    currentWeatherData = null; // Clear context
};

// ================= GEMINI CHAT LOGIC =================
const chatBody = qs("chat-body");
const chatInput = qs("chat-input");
const sendBtn = qs("chat-send");

sendBtn.onclick = handleChat;
chatInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") handleChat();
});

async function handleChat() {
    const msg = chatInput.value.trim();
    if (!msg) return;
    
    // Check if weather data exists
    if (!currentWeatherData) {
        addMsg("Please search for a city first so I know the context!", "bot");
        return;
    }

    // Check if API Key is set
    if(GEMINI_API_KEY === "AIzaSyBywx-ar8EuFvCGZlC5q9UYDtaEPCmsiZs") {
        addMsg("Error: You need to set the GEMINI_API_KEY in the code.", "bot");
        return;
    }

    addMsg(msg, "user");
    chatInput.value = "";
    chatInput.disabled = true;
    qs("chat-status").textContent = "Thinking...";

    try {
        // Construct System Context
        const context = `
        You are a weather assistant. 
        Current Weather Data for ${currentWeatherData.name}:
        - Temp: ${currentWeatherData.main.temp}¬∞C
        - Weather: ${currentWeatherData.weather[0].description}
        - Wind: ${currentWeatherData.wind.speed} m/s
        - Humidity: ${currentWeatherData.main.humidity}%
        - Calculated AQI: ${currentAqiData}
        
        User Question: "${msg}"
        
        Answer comfortably in plain text (no markdown) in under 40 words. Give advice based on the specific data above.
        `;

        const result = await model.generateContent(context);
        const response = result.response.text();
        addMsg(response, "bot");

    } catch (error) {
        console.error(error);
        addMsg("Sorry, I couldn't reach Gemini. Check console.", "bot");
    } finally {
        chatInput.disabled = false;
        qs("chat-status").textContent = "Ready";
        chatInput.focus();
    }
}

function addMsg(text, type) {
    const d = document.createElement("div");
    d.className = "chat-msg " + (type === "user" ? "user-msg" : "bot-msg");
    d.textContent = text;
    chatBody.appendChild(d);
    chatBody.scrollTop = chatBody.scrollHeight;
}
</script>

</body>
</html> -->
<!-- <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dynamic Weather & AI Assistant</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  body{font-family:Poppins,sans-serif;min-height:100vh;margin:0;display:flex;justify-content:center;background:linear-gradient(135deg,#fceabb,#f8b500);}
  .page-container{position:absolute;max-width:360px;width:90%;opacity:0;pointer-events:none;transform:scale(.97);transition:.3s;}
  .page-container.active{opacity:1;pointer-events:auto;transform:scale(1);}
  .input-card{background:#fff;padding:30px;border-radius:20px;text-align:center;box-shadow:0 15px 30px rgba(0,0,0,.25);}
  #city-input{width:100%;padding:12px;border-radius:10px;border:1px solid #ddd;margin-bottom:15px;box-sizing: border-box;}
  #search-btn{width:100%;padding:12px;border:none;border-radius:10px;font-size:18px;color:white;background:#ff9966;cursor:pointer;}
  h2{color:white;text-align:center}
  #weather-icon{display:block;margin:auto;width:100px}
  #temperature{font-size:72px;color:white;text-align:center;}
  #feels-like,#description{text-align:center;color:#f1f1f1}
  
  /* AQI Styles */
  #aqi-card{background:rgba(0,0,0,.35);border-radius:15px;padding:15px;margin:15px 0;color:white;}
  .aqi-bar{position:relative;height:8px;border-radius:10px;background:linear-gradient(90deg, #00e400 0%, #ffff00 20%, #ff7e00 40%, #ff0000 60%, #8f3f97 80%, #7e0023 100%); margin-top: 10px;}
  #aqi-dot{position:absolute;top:50%;width:14px;height:14px;background:white;border-radius:50%;transform:translate(-50%,-50%);transition: left 0.5s ease; box-shadow: 0 0 5px rgba(0,0,0,0.5);}
  
  .data-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;padding:15px;border-radius:12px;background:rgba(0,0,0,.35);}
  .data-item span{font-size:12px;color:#ffd966}
  .data-item strong{font-size:17px;color:white}
  #back-btn{margin-top:20px;width:100%;padding:12px;border:none;border-radius:12px;background:#654321;color:white;cursor:pointer;}
  
  /* Chatbot Styles */
  #chatbot{position:fixed;bottom:20px;right:20px;width:280px;background:#111;border-radius:15px;color:white;overflow:hidden;font-size:13px;box-shadow: 0 10px 20px rgba(0,0,0,0.4); z-index: 100;}
  #chat-header{background:#ff9966;padding:10px;text-align:center;font-weight:600; display:flex; justify-content: space-between; align-items: center;}
  #chat-status { font-size: 10px; opacity: 0.8; }
  #chat-body{height:250px;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:8px;}
  .chat-msg{padding: 8px 12px; border-radius: 10px; max-width: 85%; line-height: 1.4;}
  .user-msg{align-self: flex-end; background: #444; color: #ffd966; border-bottom-right-radius: 2px;}
  .bot-msg{align-self: flex-start; background: #222; color: #90ee90; border-bottom-left-radius: 2px;}
  #chat-input-area{display:flex;border-top:1px solid #333;}
  #chat-input{flex:1;padding:12px;border:none;background: #222; color: white; outline: none;}
  #chat-send{background:#ff9966;border:none;color:white;padding:0 15px;cursor:pointer;font-weight: bold;}
  #chat-send:disabled { background: #555; cursor: not-allowed;}
</style>
</head>
<body>

<div id="input-page" class="page-container active">
  <div class="input-card">
    <h1>Dynamic Weather üå§Ô∏è</h1>
    <input id="city-input" placeholder="Enter city name">
    <button id="search-btn">Show Weather</button>
  </div>
</div>

<div id="details-page" class="page-container">
  <h2 id="city-name"></h2>
  <img id="weather-icon" alt="Weather Icon">
  <div id="temperature"></div>
  <div id="feels-like"></div>
  <div id="description"></div>

  <div id="aqi-card">
    <div style="display:flex; justify-content:space-between;">
      <strong id="aqi-title">AQI</strong>
      <span id="aqi-message">Loading...</span>
    </div>
    <div class="aqi-bar"><div id="aqi-dot"></div></div>
  </div>

  <div class="data-grid">
    <div class="data-item"><span>HUMIDITY</span><strong id="humidity"></strong></div>
    <div class="data-item"><span>WIND</span><strong id="wind"></strong></div>
    <div class="data-item"><span>PRESSURE</span><strong id="pressure"></strong></div>
    <div class="data-item"><span>VISIBILITY</span><strong id="visibility"></strong></div>
  </div>

  <button id="back-btn">‚Üê New Search</button>
</div>

<div id="chatbot">
  <div id="chat-header">
    <span>ü§ñ Weather AI</span>
    <span id="chat-status">Ready</span>
  </div>
  <div id="chat-body">
    <div class="chat-msg bot-msg">Hello! I'm powered by Gemini. Search for a city to start.</div>
  </div>
  <div id="chat-input-area">
    <input id="chat-input" placeholder="Ask Gemini..." />
    <button id="chat-send">‚û§</button>
  </div>
</div>

<script type="importmap">
  {
    "imports": {
      "@google/generative-ai": "https://esm.run/@google/generative-ai"
    }
  }
</script>

<script type="module">
import { GoogleGenerativeAI } from "@google/generative-ai";

// ================= CONFIGURATION =================
// üî¥ IMPORTANT: Replace this with your actual Gemini API Key
const GEMINI_API_KEY = "YOUR_GEMINI_API_KEY_HERE"; 
const OWM_API_KEY = "043aa3f3dfcc0cc451d7c3c8d2dab5a2"; 

const WEATHER_URL = "https://api.openweathermap.org/data/2.5/weather";
const AQI_URL = "https://api.openweathermap.org/data/2.5/air_pollution";
const ICON_URL = "https://openweathermap.org/img/wn/";

// Gemini Setup
let genAI, model;
try {
    genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
    model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
} catch (e) {
    console.error("Gemini Init Error", e);
}

// App State
let currentWeatherData = null;
let currentAqiValue = 0;

const qs = id => document.getElementById(id);

// ================= WEATHER & AQI LOGIC =================
qs("search-btn").onclick = async () => {
    const city = qs("city-input").value.trim();
    if (!city) { alert("Please enter a city name"); return; }
    
    qs("search-btn").textContent = "Loading...";

    try {
        // 1. Fetch Weather
        const res = await fetch(`${WEATHER_URL}?q=${city}&appid=${OWM_API_KEY}&units=metric`);
        if (!res.ok) throw new Error("City not found");
        currentWeatherData = await res.json();
        updateWeatherUI(currentWeatherData);

        // 2. Fetch Pollution Data
        const { lat, lon } = currentWeatherData.coord;
        const aqiRes = await fetch(`${AQI_URL}?lat=${lat}&lon=${lon}&appid=${OWM_API_KEY}`);
        const aqiData = await aqiRes.json();
        
        // 3. Calculate ACCURATE AQI based on PM2.5 (US EPA Standard)
        const pm2_5 = aqiData.list[0].components.pm2_5;
        currentAqiValue = calculateUS_AQI(pm2_5);
        updateAqiUI(currentAqiValue);

        // Transition
        qs("input-page").classList.remove("active");
        qs("details-page").classList.add("active");
        
        // Notify Chat
        addMsg(`Weather updated for ${currentWeatherData.name}. AQI is ${currentAqiValue}. Ask me for advice!`, "bot");

    } catch (error) {
        alert(error.message);
    } finally {
        qs("search-btn").textContent = "Show Weather";
    }
};

// üü¢ NEW: Official US EPA AQI Calculation Algorithm
function calculateUS_AQI(pm25) {
    // Breakpoints for PM2.5 (¬µg/m¬≥) -> AQI
    // Source: https://www.airnow.gov/aqi/aqi-basics/
    if (pm25 <= 12.0) return calcLinear(50, 0, 12.0, 0, pm25);
    if (pm25 <= 35.4) return calcLinear(100, 51, 35.4, 12.1, pm25);
    if (pm25 <= 55.4) return calcLinear(150, 101, 55.4, 35.5, pm25);
    if (pm25 <= 150.4) return calcLinear(200, 151, 150.4, 55.5, pm25);
    if (pm25 <= 250.4) return calcLinear(300, 201, 250.4, 150.5, pm25);
    if (pm25 <= 350.4) return calcLinear(400, 301, 350.4, 250.5, pm25);
    if (pm25 <= 500.4) return calcLinear(500, 401, 500.4, 350.5, pm25);
    return 500; // Hazardous+
}

function calcLinear(aqiHigh, aqiLow, concHigh, concLow, conc) {
    return Math.round(((aqiHigh - aqiLow) / (concHigh - concLow)) * (conc - concLow) + aqiLow);
}

function updateAqiUI(aqi) {
    qs("aqi-title").textContent = "AQI " + aqi;
    
    let msg = "Good";
    if (aqi > 50) msg = "Moderate";
    if (aqi > 100) msg = "Unhealthy for Sensitive";
    if (aqi > 150) msg = "Unhealthy";
    if (aqi > 200) msg = "Very Unhealthy";
    if (aqi > 300) msg = "Hazardous";
    
    qs("aqi-message").textContent = msg;
    
    // Cap percentage at 100% so dot doesn't fly off screen
    const percent = Math.min((aqi / 300) * 100, 100); 
    qs("aqi-dot").style.left = percent + "%";
}

function updateWeatherUI(data) {
    qs("city-name").textContent = data.name + ", " + data.sys.country;
    qs("weather-icon").src = `${ICON_URL}${data.weather[0].icon}@2x.png`;
    qs("temperature").textContent = Math.round(data.main.temp) + "¬∞C";
    qs("feels-like").textContent = `Feels like ${Math.round(data.main.feels_like)}¬∞C`;
    qs("description").textContent = data.weather[0].description.toUpperCase();
    qs("humidity").textContent = data.main.humidity + "%";
    qs("wind").textContent = data.wind.speed + " m/s";
    qs("pressure").textContent = data.main.pressure + " hPa";
    qs("visibility").textContent = (data.visibility / 1000).toFixed(1) + " km";
}

qs("back-btn").onclick = () => {
    qs("details-page").classList.remove("active");
    qs("input-page").classList.add("active");
    qs("city-input").value = "";
};

// ================= GEMINI CHAT LOGIC =================
const chatBody = qs("chat-body");
const chatInput = qs("chat-input");
const sendBtn = qs("chat-send");

sendBtn.onclick = handleChat;
chatInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") handleChat();
});

async function handleChat() {
    const msg = chatInput.value.trim();
    if (!msg) return;
    
    if (!currentWeatherData) {
        addMsg("Please search for a city first!", "bot");
        return;
    }

    if(GEMINI_API_KEY.includes("YOUR_GEMINI")) {
        addMsg("Error: Missing Gemini API Key.", "bot");
        return;
    }

    addMsg(msg, "user");
    chatInput.value = "";
    chatInput.disabled = true;
    qs("chat-status").textContent = "Thinking...";

    try {
        const context = `
        You are a smart weather assistant.
        City: ${currentWeatherData.name}
        Temperature: ${currentWeatherData.main.temp}¬∞C
        Condition: ${currentWeatherData.weather[0].description}
        Humidity: ${currentWeatherData.main.humidity}%
        AQI (US Standard): ${currentAqiValue}
        
        User Query: "${msg}"
        
        Provide helpful, short advice (under 40 words). Mention the AQI if it is relevant to their question.
        `;

        const result = await model.generateContent(context);
        const response = result.response.text();
        addMsg(response, "bot");

    } catch (error) {
        console.error(error);
        addMsg("Sorry, I encountered an error connecting to Gemini.", "bot");
    } finally {
        chatInput.disabled = false;
        qs("chat-status").textContent = "Ready";
        chatInput.focus();
    }
}

function addMsg(text, type) {
    const d = document.createElement("div");
    d.className = "chat-msg " + (type === "user" ? "user-msg" : "bot-msg");
    d.textContent = text;
    chatBody.appendChild(d);
    chatBody.scrollTop = chatBody.scrollHeight;
}
</script>

</body>
</html> -->
<!-- <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weather & AQI Compare</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  /* GLOBAL STYLES */
  body{font-family:Poppins,sans-serif;min-height:100vh;margin:0;display:flex;justify-content:center;background:linear-gradient(135deg,#fceabb,#f8b500);overflow-x:hidden;}
  
  /* CONTAINER TRANSITIONS */
  .page-container{position:absolute;max-width:400px;width:95%;opacity:0;pointer-events:none;transform:scale(.95);transition:.3s ease-in-out; display:none;}
  .page-container.active{opacity:1;pointer-events:auto;transform:scale(1); display:block; position:relative;}

  /* CARDS */
  .card{background:#fff;padding:25px;border-radius:20px;box-shadow:0 15px 30px rgba(0,0,0,.25); text-align:center;}
  
  /* INPUTS & BUTTONS */
  input{width:100%;padding:12px;border-radius:10px;border:1px solid #ddd;margin-bottom:10px;box-sizing:border-box;font-family:inherit;}
  button{width:100%;padding:12px;border:none;border-radius:10px;font-size:16px;font-weight:600;color:white;cursor:pointer;transition:.2s;}
  button:active{transform:scale(0.98);}
  
  .btn-primary{background:#ff9966;}
  .btn-secondary{background:#654321; margin-top:10px;}
  .btn-accent{background:#4a90e2; margin-bottom:10px;}

  /* HOME PAGE */
  h1{margin:0 0 20px 0; font-size: 24px;}
  
  /* DETAILS PAGE */
  #weather-icon{width:100px;margin:auto;display:block;}
  #temperature{font-size:64px;color:white;font-weight:700;}
  .weather-desc{color:#f0f0f0; margin-bottom:15px;}
  
  /* AQI WIDGET (Single City) */
  #aqi-card{background:rgba(0,0,0,.3);border-radius:15px;padding:15px;color:white;margin-bottom:15px;}
  .aqi-bar{height:8px;background:linear-gradient(90deg,#00e400,#ffff00,#ff7e00,#ff0000,#8f3f97,#7e0023);border-radius:10px;position:relative;margin-top:8px;}
  #aqi-dot{width:14px;height:14px;background:#fff;border-radius:50%;position:absolute;top:50%;transform:translate(-50%,-50%);box-shadow:0 0 5px rgba(0,0,0,0.5);}

  /* MULTI-CITY COMPARE PAGE */
  #compare-list { max-height: 400px; overflow-y: auto; padding: 5px; }
  .city-input-group { display: flex; gap: 5px; margin-bottom: 5px; }
  .remove-btn { width: 40px; background: #ff4444; }
  
  .aqi-result-card { 
      padding: 15px; 
      margin-bottom: 10px; 
      border-radius: 12px; 
      color: white; 
      display: flex; 
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }
  .aqi-score { font-size: 24px; font-weight: bold; }
  .aqi-city { font-size: 18px; font-weight: 600; }
  .aqi-status { font-size: 12px; opacity: 0.9; }

  /* AQI COLOR CLASSES */
  .bg-good { background: #00c853; }      /* 0-50 */
  .bg-mod { background: #ffd600; color: #333; } /* 51-100 */
  .bg-sens { background: #ff6d00; }      /* 101-150 */
  .bg-unhealthy { background: #d50000; } /* 151-200 */
  .bg-very { background: #aa00ff; }      /* 201-300 */
  .bg-haz { background: #3e2723; }       /* 300+ */

  /* CHATBOT */
  #chatbot{position:fixed;bottom:20px;right:20px;width:280px;background:#111;border-radius:15px;color:white;z-index:100;box-shadow:0 10px 20px rgba(0,0,0,0.4);font-size:13px;}
  #chat-header{background:#ff9966;padding:10px;font-weight:600;text-align:center;}
  #chat-body{height:220px;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:8px;}
  .chat-msg{padding:8px 12px;border-radius:10px;max-width:85%;}
  .bot-msg{background:#222;color:#90ee90;align-self:flex-start;}
  .user-msg{background:#444;color:#ffd966;align-self:flex-end;}
  #chat-input-area{display:flex;border-top:1px solid #333;}
  #chat-input{flex:1;padding:10px;background:#222;border:none;color:white;outline:none;}
  #chat-send{width:auto;padding:0 15px;border-radius:0;background:#ff9966;}

  /* Utilities */
  .hidden { display: none; }
</style>
</head>
<body>

<div id="home-page" class="page-container active">
  <div class="card">
    <h1>Weather & Air Quality</h1>
    <input id="city-input" placeholder="Enter city name (e.g., Tokyo)">
    <button id="search-btn" class="btn-primary">Get Weather</button>
    <div style="margin: 15px 0; color: #888;">‚Äî OR ‚Äî</div>
    <button id="btn-goto-compare" class="btn-accent">Compare 5 Cities AQI üìä</button>
  </div>
</div>

<div id="details-page" class="page-container">
  <h2 id="city-name" style="color:white;text-align:center;text-shadow:0 2px 4px rgba(0,0,0,0.2);"></h2>
  <img id="weather-icon" alt="icon">
  <div id="temperature" style="text-align:center;"></div>
  <div id="description" class="weather-desc" style="text-align:center;"></div>

  <div id="aqi-card">
    <div style="display:flex;justify-content:space-between;">
      <strong id="aqi-title">AQI</strong>
      <span id="aqi-message">Loading...</span>
    </div>
    <div class="aqi-bar"><div id="aqi-dot"></div></div>
  </div>

  <div class="card" style="background:rgba(0,0,0,0.3);color:white;padding:15px;">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      <div>Humidity: <strong id="humidity"></strong></div>
      <div>Wind: <strong id="wind"></strong></div>
    </div>
  </div>

  <button id="back-home-btn" class="btn-secondary">‚Üê Back</button>
</div>

<div id="compare-page" class="page-container">
  <div class="card">
    <h3>Compare Air Quality</h3>
    <div id="compare-inputs">
      </div>
    <button id="add-city-btn" style="background:#ddd;color:#333;margin-bottom:10px;">+ Add Another City</button>
    <button id="compare-btn" class="btn-primary">Compare Now</button>
    
    <div id="compare-results" style="margin-top:20px;"></div>
    
    <button id="back-compare-btn" class="btn-secondary">‚Üê Back Home</button>
  </div>
</div>

<div id="chatbot">
  <div id="chat-header">ü§ñ Gemini AI Assistant</div>
  <div id="chat-body">
    <div class="chat-msg bot-msg">Hi! Ask me about weather or AQI differences.</div>
  </div>
  <div id="chat-input-area">
    <input id="chat-input" placeholder="Type a message..." />
    <button id="chat-send">‚û§</button>
  </div>
</div>

<script type="importmap">
  { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
</script>

<script type="module">
import { GoogleGenerativeAI } from "@google/generative-ai";

// ================= CONFIG =================
// ‚ö†Ô∏è IMPORTANT: Paste your Gemini API key inside the quotes below
const GEMINI_API_KEY = "AIzaSyBywx-ar8EuFvCGZlC5q9UYDtaEPCmsiZs"; 
const OWM_API_KEY = "043aa3f3dfcc0cc451d7c3c8d2dab5a2";

// Initialize Gemini
let genAI, model;
try {
    genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
    model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
} catch(e) { console.error("Gemini Error", e); }

// State
let currentWeatherData = null;
let currentAqiData = 0;
let comparisonData = []; // Stores last comparison result for AI context

// DOM Helpers
const qs = id => document.getElementById(id);
const showPage = (id) => {
    document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
    qs(id).classList.add('active');
};

// ================= 1. SINGLE CITY SEARCH =================
qs("search-btn").onclick = async () => {
    const city = qs("city-input").value.trim();
    if (!city) return alert("Enter a city");
    
    qs("search-btn").textContent = "Loading...";
    try {
        const wData = await fetchWeather(city);
        currentWeatherData = wData;
        const aqiVal = await fetchAQI(wData.coord.lat, wData.coord.lon);
        currentAqiData = aqiVal;

        updateDetailsUI(wData, aqiVal);
        showPage("details-page");
        
        // AI Intro
        addMsg(`Here is the weather for ${city}. AQI is ${aqiVal}.`, "bot");
    } catch (e) { alert(e.message); }
    finally { qs("search-btn").textContent = "Get Weather"; }
};

// ================= 2. COMPARE CITIES LOGIC =================
const inputContainer = qs("compare-inputs");
let cityInputs = ["lucknow", "Mumbai"]; // Default start

function renderInputs() {
    inputContainer.innerHTML = "";
    cityInputs.forEach((city, idx) => {
        const div = document.createElement("div");
        div.className = "city-input-group";
        div.innerHTML = `
            <input value="${city}" onchange="updateCityArr(${idx}, this.value)" placeholder="City ${idx+1}">
            ${cityInputs.length > 2 ? `<button class="remove-btn" onclick="removeCity(${idx})">√ó</button>` : ''}
        `;
        inputContainer.appendChild(div);
    });
}
// Expose functions to window for HTML onclicks
window.updateCityArr = (i, val) => cityInputs[i] = val;
window.removeCity = (i) => { cityInputs.splice(i, 1); renderInputs(); };

qs("add-city-btn").onclick = () => {
    if (cityInputs.length >= 5) return alert("Max 5 cities allowed");
    cityInputs.push("");
    renderInputs();
};

qs("btn-goto-compare").onclick = () => {
    showPage("compare-page");
    renderInputs();
};

qs("compare-btn").onclick = async () => {
    const cities = cityInputs.filter(c => c.trim() !== "");
    if (cities.length < 2) return alert("Enter at least 2 cities");

    const btn = qs("compare-btn");
    btn.textContent = "Comparing...";
    qs("compare-results").innerHTML = "";
    comparisonData = [];

    try {
        // Fetch all in parallel
        const promises = cities.map(async (city) => {
            try {
                const w = await fetchWeather(city);
                const aqi = await fetchAQI(w.coord.lat, w.coord.lon);
                return { city: w.name, aqi, error: null };
            } catch (e) {
                return { city, error: "Not Found" };
            }
        });

        const results = await Promise.all(promises);
        comparisonData = results; // Save for AI

        // Render Results
        results.sort((a, b) => (a.aqi || 0) - (b.aqi || 0)); // Sort Good to Bad
        
        results.forEach(res => {
            const el = document.createElement("div");
            if (res.error) {
                el.className = "aqi-result-card";
                el.style.background = "#555";
                el.innerHTML = `<span>${res.city}</span><span>Not Found</span>`;
            } else {
                const colorClass = getAqiColorClass(res.aqi);
                el.className = `aqi-result-card ${colorClass}`;
                el.innerHTML = `
                    <div class="aqi-city">${res.city}</div>
                    <div style="text-align:right">
                        <div class="aqi-score">${res.aqi}</div>
                        <div class="aqi-status">${getAqiLabel(res.aqi)}</div>
                    </div>
                `;
            }
            qs("compare-results").appendChild(el);
        });

        addMsg(`I've compared the AQI for these cities. ${results[0].city} has the cleanest air!`, "bot");

    } catch (e) { console.error(e); }
    finally { btn.textContent = "Compare Now"; }
};

// ================= API HELPERS =================
async function fetchWeather(city) {
    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${OWM_API_KEY}&units=metric`);
    if (!res.ok) throw new Error(`City ${city} not found`);
    return await res.json();
}

async function fetchAQI(lat, lon) {
    const res = await fetch(`https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${OWM_API_KEY}`);
    const data = await res.json();
    return calculateUS_AQI(data.list[0].components.pm2_5);
}

// US AQI Calc (Simplified)
function calculateUS_AQI(pm25) {
    if (pm25 <= 12.0) return calc(50, 0, 12, 0, pm25);
    if (pm25 <= 35.4) return calc(100, 51, 35.4, 12.1, pm25);
    if (pm25 <= 55.4) return calc(150, 101, 55.4, 35.5, pm25);
    if (pm25 <= 150.4) return calc(200, 151, 150.4, 55.5, pm25);
    return pm25 > 250 ? 300 : 200; 
}
function calc(Ih, Il, Ch, Cl, C) {
    return Math.round(((Ih - Il) / (Ch - Cl)) * (C - Cl) + Il);
}

function getAqiColorClass(aqi) {
    if(aqi <= 50) return 'bg-good';
    if(aqi <= 100) return 'bg-mod';
    if(aqi <= 150) return 'bg-sens';
    if(aqi <= 200) return 'bg-unhealthy';
    return 'bg-haz';
}
function getAqiLabel(aqi) {
    if(aqi <= 50) return 'Good';
    if(aqi <= 100) return 'Moderate';
    if(aqi <= 150) return 'Sensitive Groups';
    return 'Unhealthy';
}

// ================= UI UPDATERS =================
function updateDetailsUI(w, aqi) {
    qs("city-name").textContent = w.name;
    qs("weather-icon").src = `https://openweathermap.org/img/wn/${w.weather[0].icon}@4x.png`;
    qs("temperature").textContent = Math.round(w.main.temp) + "¬∞";
    qs("description").textContent = w.weather[0].description;
    qs("humidity").textContent = w.main.humidity + "%";
    qs("wind").textContent = w.wind.speed + "m/s";
    
    qs("aqi-title").textContent = "AQI " + aqi;
    qs("aqi-message").textContent = getAqiLabel(aqi);
    qs("aqi-dot").style.left = Math.min((aqi/300)*100, 100) + "%";
}

qs("back-home-btn").onclick = () => showPage("home-page");
qs("back-compare-btn").onclick = () => showPage("home-page");

// ================= CHATBOT =================
qs("chat-send").onclick = async () => {
    const input = qs("chat-input");
    const msg = input.value.trim();
    if (!msg) return;

    if (GEMINI_API_KEY.includes("YOUR_GEMINI")) return alert("Set API Key first!");

    addMsg(msg, "user");
    input.value = "";
    
    let context = "";
    if (qs("compare-page").classList.contains("active") && comparisonData.length > 0) {
        context = `Comparison Data: ${JSON.stringify(comparisonData)}.`;
    } else if (currentWeatherData) {
        context = `City: ${currentWeatherData.name}, Temp: ${currentWeatherData.main.temp}, AQI: ${currentAqiData}.`;
    } else {
        context = "User has not searched for anything yet.";
    }

    const prompt = `Context: ${context} \nUser Question: ${msg} \nAnswer in under 30 words.`;
    
    try {
        const result = await model.generateContent(prompt);
        addMsg(result.response.text(), "bot");
    } catch(e) { addMsg("Error connecting to AI.", "bot"); }
};

function addMsg(text, type) {
    const d = document.createElement("div");
    d.className = `chat-msg ${type === "user" ? "user-msg" : "bot-msg"}`;
    d.textContent = text;
    qs("chat-body").appendChild(d);
    qs("chat-body").scrollTop = qs("chat-body").scrollHeight;
}
</script>
</body>
</html> -->
<!-- <!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dark Glass Weather</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  /* --- GLOBAL STYLES --- */
  body {
    font-family: 'Poppins', sans-serif;
    min-height: 100vh;
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    /* Dark, deep gradient background */
    background: linear-gradient(to bottom right, #0f2027, #203a43, #2c5364);
    color: white;
    overflow-x: hidden;
  }

  /* --- PAGE CONTAINERS & TRANSITIONS --- */
  .page-container {
    position: absolute;
    width: 90%;
    max-width: 800px; /* Wider for the grid layout */
    opacity: 0;
    pointer-events: none;
    transform: scale(0.95);
    transition: all 0.4s ease-in-out;
    display: none;
  }
  .page-container.active {
    opacity: 1;
    pointer-events: auto;
    transform: scale(1);
    display: block;
  }

  /* --- GLASSMORPHISM CARD STYLE --- */
  .glass-card {
    background: rgba(255, 255, 255, 0.1); /* Low opacity white */
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.18);
    padding: 20px;
    color: white;
  }

  /* --- INPUT PAGE SPECIFIC --- */
  .input-card-content {
    text-align: center;
    max-width: 400px;
    margin: auto;
  }
  input {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    background: rgba(255, 255, 255, 0.1);
    color: white;
    margin-bottom: 15px;
    box-sizing: border-box;
    font-family: inherit;
  }
  input::placeholder { color: rgba(255, 255, 255, 0.6); }
  button {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    color: white;
    cursor: pointer;
    transition: 0.2s;
  }
  .btn-primary { background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); }
  .btn-primary:hover { background: rgba(255, 255, 255, 0.3); }

  /* --- DETAILS PAGE GRID LAYOUT --- */
  .weather-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
  }
  .main-temp-box { display: flex; align-items: center; }
  #weather-icon { width: 80px; height: 80px; }
  #temperature { font-size: 48px; font-weight: 700; line-height: 1; }
  .city-name { font-size: 24px; opacity: 0.9; }
  .weather-desc { font-size: 14px; opacity: 0.7; }

  /* Grid for weather cards */
  .weather-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
  }

  /* --- INDIVIDUAL CARD STYLES --- */
  .card-label {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    opacity: 0.7;
    margin-bottom: 10px;
    display: block;
  }
  .card-value {
    font-size: 28px;
    font-weight: 700;
  }
  .card-subtext {
    font-size: 12px;
    opacity: 0.7;
    margin-top: 5px;
  }

  /* Gauges (Simple CSS representation) */
  .gauge-container {
    position: relative;
    width: 60px;
    height: 60px;
    float: right;
  }
  .gauge-ring {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    border: 5px solid rgba(255,255,255,0.1);
    box-sizing: border-box;
  }
  .gauge-fill {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    border-radius: 50%;
    border: 5px solid;
    border-color: transparent;
    box-sizing: border-box;
    transform: rotate(-90deg); /* Start from top */
  }
  /* Specific gauge colors based on the image */
  .aqi-gauge .gauge-fill { border-top-color: #e74c3c; border-right-color: #f1c40f; } /* Red/Yellow */
  .humidity-gauge .gauge-fill { border-top-color: #3498db; } /* Blue */
  .uv-gauge .gauge-fill { border-top-color: #9b59b6; } /* Purple */

  /* Back Button */
  #back-home-btn {
    background: rgba(255, 255, 255, 0.1);
    margin-top: 20px;
    width: auto;
    padding: 10px 20px;
  }

  /* --- CHATBOT (Dark Theme) --- */
  #chatbot {
    position: fixed; bottom: 20px; right: 20px; width: 300px;
    background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px);
    border-radius: 15px; border: 1px solid rgba(255,255,255,0.1);
    z-index: 100; overflow: hidden;
  }
  #chat-header {
    background: rgba(255,255,255,0.1); padding: 12px; font-weight: 600;
    text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  #chat-body {
    height: 250px; overflow-y: auto; padding: 15px;
    display: flex; flex-direction: column; gap: 10px;
  }
  .chat-msg { padding: 8px 12px; border-radius: 10px; max-width: 80%; font-size: 13px; }
  .bot-msg { background: rgba(255,255,255,0.1); align-self: flex-start; }
  .user-msg { background: rgba(52, 152, 219, 0.4); align-self: flex-end; }
  #chat-input-area { display: flex; border-top: 1px solid rgba(255,255,255,0.1); }
  #chat-input {
    flex: 1; padding: 12px; background: transparent; border: none;
    color: white; outline: none;
  }
  #chat-send {
    width: auto; padding: 0 15px; background: rgba(255,255,255,0.1);
    border-left: 1px solid rgba(255,255,255,0.1); color: white;
  }
</style>
</head>
<body>

<div id="home-page" class="page-container active">
  <div class="glass-card input-card-content">
    <h1>Dark Weather</h1>
    <input id="city-input" placeholder="Enter city name...">
    <button id="search-btn" class="btn-primary">Search</button>
  </div>
</div>

<div id="details-page" class="page-container">
  <div class="glass-card weather-header">
    <div>
      <div class="city-name" id="city-name"></div>
      <div class="weather-desc" id="description"></div>
    </div>
    <div class="main-temp-box">
      <img id="weather-icon" alt="icon">
      <div id="temperature"></div>
    </div>
  </div>

  <div class="weather-grid">
    <div class="glass-card">
      <span class="card-label">Feels Like</span>
      <div class="card-value" id="feels-like"></div>
      <div class="card-subtext">Typical for this weather.</div>
    </div>

    <div class="glass-card">
      <span class="card-label">Wind</span>
      <div class="card-value" id="wind"></div>
      <div class="card-subtext">Current wind speed.</div>
    </div>

    <div class="glass-card">
      <div class="gauge-container humidity-gauge">
        <div class="gauge-ring"></div>
        <div class="gauge-fill" id="humidity-fill"></div>
      </div>
      <span class="card-label">Humidity</span>
      <div class="card-value" id="humidity"></div>
      <div class="card-subtext">Atmospheric moisture.</div>
    </div>

    <div class="glass-card">
      <div class="gauge-container aqi-gauge">
        <div class="gauge-ring"></div>
        <div class="gauge-fill" id="aqi-fill"></div>
      </div>
      <span class="card-label">AQI</span>
      <div class="card-value" id="aqi-value"></div>
      <div class="card-subtext" id="aqi-label"></div>
    </div>
    
    <div class="glass-card">
      <span class="card-label">Visibility</span>
      <div class="card-value" id="visibility"></div>
      <div class="card-subtext">Distance you can see.</div>
    </div>

    <div class="glass-card">
      <div class="gauge-container uv-gauge">
        <div class="gauge-ring"></div>
        <div class="gauge-fill" style="transform: rotate(45deg);"></div> </div>
      <span class="card-label">UV Index</span>
      <div class="card-value">3</div> <div class="card-subtext">Moderate.</div>
    </div>
  </div>

  <button id="back-home-btn">‚Üê Back</button>
</div>

<div id="chatbot">
  <div id="chat-header">ü§ñ Weather AI</div>
  <div id="chat-body">
    <div class="chat-msg bot-msg">I'm ready. Search for a city!</div>
  </div>
  <div id="chat-input-area">
    <input id="chat-input" placeholder="Ask about the weather..." />
    <button id="chat-send">‚û§</button>
  </div>
</div>

<script type="importmap">
  { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
</script>

<script type="module">
import { GoogleGenerativeAI } from "@google/generative-ai";

// --- CONFIG ---
const GEMINI_API_KEY = "YOUR_GEMINI_KEY"; // üî¥ PUT YOUR KEY HERE
const OWM_API_KEY = "043aa3f3dfcc0cc451d7c3c8d2dab5a2";

// --- INIT ---
let genAI, model;
try {
    genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
    model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
} catch(e) { console.error("Gemini Error", e); }

let currentWeatherData = null;
let currentAqiData = 0;

const qs = id => document.getElementById(id);
const showPage = (id) => {
    document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
    qs(id).classList.add('active');
};

// --- SEARCH LOGIC ---
qs("search-btn").onclick = async () => {
    const city = qs("city-input").value.trim();
    if (!city) return alert("Enter a city");
    
    qs("search-btn").textContent = "Searching...";
    try {
        const wData = await fetchWeather(city);
        currentWeatherData = wData;
        const aqiVal = await fetchAQI(wData.coord.lat, wData.coord.lon);
        currentAqiData = aqiVal;

        updateDetailsUI(wData, aqiVal);
        showPage("details-page");
        addMsg(`Loaded weather for ${city}.`, "bot");
    } catch (e) { alert(e.message); }
    finally { qs("search-btn").textContent = "Search"; }
};

// --- API FUNCTIONS ---
async function fetchWeather(city) {
    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${OWM_API_KEY}&units=metric`);
    if (!res.ok) throw new Error("City not found");
    return await res.json();
}

async function fetchAQI(lat, lon) {
    const res = await fetch(`https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${OWM_API_KEY}`);
    const data = await res.json();
    // Simple US AQI estimation from PM2.5
    const pm25 = data.list[0].components.pm2_5;
    if (pm25 <= 12) return Math.round((50/12)*pm25);
    if (pm25 <= 35.4) return Math.round(((100-51)/(35.4-12.1))*(pm25-12.1)+51);
    if (pm25 <= 55.4) return Math.round(((150-101)/(55.4-35.5))*(pm25-35.5)+101);
    return Math.round(((200-151)/(150.4-55.5))*(pm25-55.5)+151);
}

// --- UI UPDATES ---
function updateDetailsUI(w, aqi) {
    // Main Header
    qs("city-name").textContent = w.name;
    qs("weather-icon").src = `https://openweathermap.org/img/wn/${w.weather[0].icon}@2x.png`;
    qs("temperature").textContent = Math.round(w.main.temp) + "¬∞";
    qs("description").textContent = w.weather[0].description;

    // Grid Cards
    qs("feels-like").textContent = Math.round(w.main.feels_like) + "¬∞";
    qs("wind").textContent = w.wind.speed + " km/h";
    qs("visibility").textContent = (w.visibility / 1000).toFixed(1) + " km";

    // Humidity Gauge
    qs("humidity").textContent = w.main.humidity + "%";
    // Rotate fill based on percentage (simple representation)
    qs("humidity-fill").style.transform = `rotate(${w.main.humidity * 1.8}deg)`; 

    // AQI Gauge
    qs("aqi-value").textContent = aqi;
    qs("aqi-label").textContent = getAqiLabel(aqi);
    // Cap rotation for visual purposes
    const aqiRotation = Math.min(aqi, 200) * 0.9; 
    qs("aqi-fill").style.transform = `rotate(${aqiRotation}deg)`;
}

function getAqiLabel(aqi) {
    if(aqi <= 50) return 'Good';
    if(aqi <= 100) return 'Moderate';
    if(aqi <= 150) return 'Unhealthy for Sensitive';
    return 'Unhealthy';
}

qs("back-home-btn").onclick = () => showPage("home-page");

// --- CHATBOT LOGIC ---
qs("chat-send").onclick = async () => {
    const input = qs("chat-input");
    const msg = input.value.trim();
    if (!msg) return;

    if (GEMINI_API_KEY.includes("YOUR_GEMINI")) return alert("Set API Key first!");

    addMsg(msg, "user");
    input.value = "";
    
    let context = currentWeatherData 
        ? `City: ${currentWeatherData.name}, Temp: ${currentWeatherData.main.temp}¬∞C, AQI: ${currentAqiData}.`
        : "No city selected yet.";

    const prompt = `Context: ${context} \nUser Question: ${msg} \nAnswer in under 30 words.`;
    
    try {
        const result = await model.generateContent(prompt);
        addMsg(result.response.text(), "bot");
    } catch(e) { addMsg("Error connecting to AI.", "bot"); }
};

function addMsg(text, type) {
    const d = document.createElement("div");
    d.className = `chat-msg ${type === "user" ? "user-msg" : "bot-msg"}`;
    d.textContent = text;
    qs("chat-body").appendChild(d);
    qs("chat-body").scrollTop = qs("chat-body").scrollHeight;
}
</script>
</body>
</html> -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weather & AQI Glass</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
  /* ================= GLOBAL & THEME ================= */
  :root {
    --bg-gradient: linear-gradient(135deg, #0f172a, #1e293b);
    --glass-bg: rgba(30, 41, 59, 0.7);
    --glass-border: rgba(255, 255, 255, 0.1);
    --text-primary: #ffffff;
    --text-secondary: #94a3b8;
    --accent-blue: #3b82f6;
    --accent-cyan: #06b6d4;
    --card-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
  }

  body {
    font-family: 'Poppins', sans-serif;
    min-height: 100vh;
    margin: 0;
    display: flex;
    justify-content: center;
    background: var(--bg-gradient);
    color: var(--text-primary);
    overflow-x: hidden;
    padding: 20px;
    box-sizing: border-box;
  }

  /* ================= UTILITIES & COMPONENTS ================= */
  .hidden { display: none !important; }

  /* The base glass card style */
  .glass-card {
    background: var(--glass-bg);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border: 1px solid var(--glass-border);
    border-radius: 24px;
    box-shadow: var(--card-shadow);
    padding: 25px;
    box-sizing: border-box;
  }

  .page-container {
    max-width: 900px; /* Wider for grid */
    width: 100%;
    opacity: 0;
    pointer-events: none;
    transform: translateY(20px);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    display: none;
  }

  .page-container.active {
    opacity: 1;
    pointer-events: auto;
    transform: translateY(0);
    display: block;
  }

  /* Inputs & Buttons (Dark theme) */
  input {
    width: 100%;
    padding: 15px;
    border-radius: 15px;
    border: 1px solid var(--glass-border);
    background: rgba(0,0,0,0.2);
    color: white;
    margin-bottom: 15px;
    box-sizing: border-box;
    font-family: inherit;
    font-size: 16px;
    outline: none;
  }
  input::placeholder { color: var(--text-secondary); }
  input:focus { border-color: var(--accent-blue); }

  button {
    width: 100%;
    padding: 15px;
    border: none;
    border-radius: 15px;
    font-size: 16px;
    font-weight: 600;
    color: white;
    cursor: pointer;
    transition: .3s;
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
  }
  button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.6); }
  button:active { transform: scale(0.98); }
  
  .btn-secondary { background: rgba(255,255,255,0.1); box-shadow: none; margin-top: 15px; }
  .btn-secondary:hover { background: rgba(255,255,255,0.2); }
  
  .or-divider { margin: 20px 0; color: var(--text-secondary); text-align: center; font-weight: 500;}

  /* ================= HOME PAGE ================= */
  .home-container { max-width: 450px; margin: auto; text-align: center; }
  h1 { margin: 0 0 25px 0; font-size: 28px; font-weight: 700; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}

  /* ================= DETAILS PAGE (NEW GRID UI) ================= */
  #city-header { text-align: center; margin-bottom: 30px; }
  #city-name { font-size: 32px; margin: 0; font-weight: 600; }
  #weather-desc-main { color: var(--text-secondary); text-transform: capitalize; font-size: 18px; }

  /* Grid Layout for Details */
  .details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  /* Inner Card Styling */
  .detail-card {
    padding: 20px;
    border-radius: 20px;
    background: rgba(255, 255, 255, 0.03); /* Slightly lighter inside */
    border: 1px solid rgba(255,255,255,0.05);
    display: flex;
    flex-direction: column;
    position: relative;
    min-height: 180px; /* Ensure uniform height */
  }

  .card-pill {
    display: inline-block;
    background: rgba(255,255,255,0.1);
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
    color: var(--text-secondary);
    margin-bottom: 15px;
    align-self: flex-start;
  }

  .big-value {
    font-size: 42px;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 5px;
  }
  .unit { font-size: 20px; font-weight: 400; color: var(--text-secondary); }
  .card-subtext { font-size: 14px; color: var(--text-secondary); margin-top: auto; /* Pushes to bottom */ }

  /* Visual Elements inside cards */
  .card-visual-container {
    position: absolute;
    top: 20px;
    right: 20px;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* Sparkline placeholder */
  .sparkline-svg { width: 80px; height: 30px; stroke: var(--accent-cyan); fill: none; stroke-width: 2; opacity: 0.7;}

  /* Compass for Wind */
  .compass { width: 50px; height: 50px; border: 2px solid rgba(255,255,255,0.2); border-radius: 50%; position: relative; }
  .compass-arrow {
    position: absolute; top: 50%; left: 50%; width: 0; height: 0;
    border-left: 5px solid transparent; border-right: 5px solid transparent;
    border-bottom: 20px solid var(--accent-blue);
    transform-origin: center bottom; display: block;
    /* Rotation applied by JS */
  }
  .compass-N { position: absolute; top: -8px; left: 50%; transform: translateX(-50%); font-size: 10px; color: var(--text-secondary); }

  /* Circular Gauges (Humidity/AQI) */
  .gauge-svg { transform: rotate(-90deg); width: 60px; height: 60px;}
  .gauge-bg { fill: none; stroke: rgba(255,255,255,0.1); stroke-width: 4; }
  .gauge-fill { fill: none; stroke: var(--accent-cyan); stroke-width: 4; stroke-linecap: round; transition: stroke-dashoffset 1s ease;}
  /* The dasharray is circumference (2 * pi * r). r=26 -> ~163 */

  /* ================= COMPARE PAGE ================= */
  #compare-list { max-height: 400px; overflow-y: auto; padding-right: 5px; }
  /* Custom Scrollbar for dark theme */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 10px;}
  ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px;}

  .city-input-group { display: flex; gap: 10px; margin-bottom: 10px; }
  .remove-btn { width: 50px; background: rgba(255, 68, 68, 0.2); color: #ff4444; box-shadow: none; padding: 0;}
  .remove-btn:hover { background: rgba(255, 68, 68, 0.4); }

  .aqi-result-card {
    background: rgba(255,255,255,0.05);
    padding: 20px; margin-bottom: 15px; border-radius: 16px;
    display: flex; justify-content: space-between; align-items: center;
    border-left: 5px solid #ddd; /* Default border color */
    transition: transform 0.2s;
  }
  .aqi-result-card:hover { transform: translateX(5px); background: rgba(255,255,255,0.08); }
  .aqi-city-name { font-size: 18px; font-weight: 600; }
  .aqi-score-box { text-align: right; }
  .aqi-val { font-size: 24px; font-weight: 700; }
  .aqi-status-label { font-size: 12px; opacity: 0.8; }

  /* AQI Status Colors (Border & Text) */
  .aqi-good { border-color: #00e400; color: #00e400; }
  .aqi-mod { border-color: #ffff00; color: #ffff00; }
  .aqi-sens { border-color: #ff7e00; color: #ff7e00; }
  .aqi-unhealthy { border-color: #ff0000; color: #ff0000; }
  .aqi-very { border-color: #8f3f97; color: #8f3f97; }
  .aqi-haz { border-color: #7e0023; color: #ff5e89; }

  /* ================= CHATBOT ================= */
  #chatbot {
    position: fixed; bottom: 20px; right: 20px; width: 300px;
    background: var(--glass-bg); backdrop-filter: blur(15px);
    border: 1px solid var(--glass-border); border-radius: 20px;
    z-index: 100; box-shadow: var(--card-shadow); overflow: hidden;
  }
  #chat-header { background: rgba(59, 130, 246, 0.2); padding: 15px; font-weight: 600; text-align: center; border-bottom: 1px solid var(--glass-border);}
  #chat-body { height: 250px; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
  .chat-msg { padding: 10px 15px; border-radius: 15px; max-width: 85%; font-size: 13px; line-height: 1.4;}
  .bot-msg { background: rgba(255,255,255,0.1); align-self: flex-start; border-bottom-left-radius: 2px; }
  .user-msg { background: var(--accent-blue); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
  #chat-input-area { display: flex; border-top: 1px solid var(--glass-border); padding: 5px; background: rgba(0,0,0,0.2);}
  #chat-input { flex: 1; padding: 10px; background: transparent; border: none; color: white; outline: none; margin: 0;}
  #chat-send { width: auto; padding: 0 20px; border-radius: 10px; background: var(--accent-cyan); margin-left: 5px;}

  @media (max-width: 600px) {
      .details-grid { grid-template-columns: 1fr 1fr; } /* 2 columns on mobile */
      #chatbot { width: 90%; left: 5%; right: 5%; bottom: 10px; }
  }
</style>
</head>
<body>

<div id="home-page" class="page-container active home-container">
  <div class="glass-card">
    <h1>Weather & AQI</h1>
    <input id="city-input" placeholder="Enter city (e.g., London)">
    <button id="search-btn">Search Weather</button>
    <div class="or-divider">OR</div>
    <button id="btn-goto-compare" style="background: linear-gradient(135deg, #8e2de2, #4a00e0);">Compare 5 Cities AQI üìä</button>
  </div>
</div>

<div id="details-page" class="page-container">
  <div class="glass-card">
    <div id="city-header">
        <h2 id="city-name">City Name</h2>
        <div id="weather-desc-main">Description</div>
    </div>

    <div class="details-grid">
        <div class="detail-card">
            <span class="card-pill">Temperature</span>
            <div class="big-value"><span id="temp-val">--</span><span class="unit">¬∞</span></div>
            <div id="temp-desc-sub" class="card-subtext">Steady. Tomorrow likely similar.</div>
            <div class="card-visual-container">
                <svg class="sparkline-svg" viewBox="0 0 80 30"><path d="M0,15 Q10,5 20,15 T40,15 T60,5 T80,20" /></svg>
            </div>
        </div>

        <div class="detail-card">
            <span class="card-pill">Feels like</span>
            <div class="big-value"><span id="feels-val">--</span><span class="unit">¬∞</span></div>
            <div id="feels-desc-sub" class="card-subtext">Actual feel.</div>
             <div class="card-visual-container">
                 <svg class="sparkline-svg" viewBox="0 0 80 30" style="stroke: var(--accent-blue)"><path d="M0,20 Q20,25 40,15 T80,5" /></svg>
            </div>
        </div>

        <div class="detail-card">
            <span class="card-pill">Wind</span>
            <div class="big-value"><span id="wind-speed">--</span><span class="unit"> km/h</span></div>
             <div id="wind-dir-text" class="card-subtext" style="margin-bottom: 5px;">From the N</div>
            <div class="card-subtext">Steady breeze expected.</div>
            <div class="card-visual-container">
                <div class="compass">
                    <span class="compass-N">N</span>
                    <div id="wind-arrow" class="compass-arrow" style="transform: translate(-50%, -100%) rotate(0deg);"></div>
                </div>
            </div>
        </div>

        <div class="detail-card">
            <span class="card-pill">Humidity</span>
            <div class="big-value"><span id="humidity-val">--</span><span class="unit">%</span></div>
            <div class="card-subtext">Current atmospheric moisture.</div>
             <div class="card-visual-container">
                <svg class="gauge-svg" viewBox="0 0 60 60">
                    <circle class="gauge-bg" cx="30" cy="30" r="26"/>
                    <circle id="humidity-gauge-fill" class="gauge-fill" cx="30" cy="30" r="26" stroke-dasharray="163" stroke-dashoffset="163"/>
                </svg>
            </div>
        </div>

        <div class="detail-card">
            <span class="card-pill">AQI</span>
            <div class="big-value" id="aqi-val">--</div>
            <div id="aqi-status-text" style="font-weight: 600; margin-bottom: 5px;">-</div>
            <div class="card-subtext">Based on PM2.5 pollutants.</div>
            <div class="card-visual-container">
                 <svg class="gauge-svg" viewBox="0 0 60 60">
                    <circle class="gauge-bg" cx="30" cy="30" r="26"/>
                    <circle id="aqi-gauge-fill" class="gauge-fill" cx="30" cy="30" r="26" stroke-dasharray="163" stroke-dashoffset="163"/>
                </svg>
            </div>
        </div>
        
         <div class="detail-card">
            <span class="card-pill">Visibility</span>
            <div class="big-value"><span id="visibility-val">--</span><span class="unit"> km</span></div>
            <div class="card-subtext">Distance you can see clearly.</div>
        </div>

         <div class="detail-card">
            <span class="card-pill">Pressure</span>
            <div class="big-value"><span id="pressure-val">--</span><span class="unit"> hPa</span></div>
            <div class="card-subtext">Atmospheric pressure at sea level.</div>
        </div>

    </div> <button id="back-home-btn" class="btn-secondary">‚Üê Back to Search</button>
  </div>
</div>

<div id="compare-page" class="page-container">
  <div class="glass-card">
    <h2 style="text-align: center;">Compare Air Quality</h2>
    <p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">Enter up to 5 cities to compare realtime pollution.</p>
    
    <div id="compare-inputs">
      </div>
    
    <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button id="add-city-btn" class="btn-secondary" style="margin-top:0;">+ Add City</button>
        <button id="compare-btn" style="flex: 2;">Compare Now</button>
    </div>
    
    <div id="compare-results" style="margin-top:30px;">
        </div>
    
    <button id="back-compare-btn" class="btn-secondary">‚Üê Back Home</button>
  </div>
</div>

<div id="chatbot">
  <div id="chat-header">ü§ñ Weather AI</div>
  <div id="chat-body">
    <div class="chat-msg bot-msg">Welcome! Search a city and I can give you insights based on the weather data.</div>
  </div>
  <div id="chat-input-area">
    <input id="chat-input" placeholder="Ask me something..." />
    <button id="chat-send">‚û§</button>
  </div>
</div>

<script type="importmap">
  { "imports": { "@google/generative-ai": "https://esm.run/@google/generative-ai" } }
</script>

<script type="module">
import { GoogleGenerativeAI } from "@google/generative-ai";

// üî¥üî¥üî¥ IMPORTANT: PUT YOUR GEMINI KEY HERE üî¥üî¥üî¥
const GEMINI_API_KEY = "AIzaSyBywx-ar8EuFvCGZlC5q9UYDtaEPCmsiZs"; 
const OWM_API_KEY = "043aa3f3dfcc0cc451d7c3c8d2dab5a2"; // Free OWM Key

// Init AI
let genAI, model;
try {
    genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
    model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
} catch(e) { console.error("AI Init Error", e); }

// App State
let currentWeatherData = null;
let currentAqiData = 0;
let comparisonContext = "";

// Helpers
const qs = id => document.getElementById(id);
const showPage = (id) => {
    document.querySelectorAll('.page-container').forEach(p => p.classList.remove('active'));
    qs(id).classList.add('active');
    // Reset chat context when moving pages unless specified
    if(id === 'home-page') { currentWeatherData = null; comparisonContext = ""; }
};

// ================= MAIN SEARCH LOGIC =================
qs("search-btn").onclick = async () => {
    const city = qs("city-input").value.trim();
    if (!city) return alert("Please enter a city");
    
    const btn = qs("search-btn");
    btn.textContent = "Searching..."; btn.disabled = true;
    
    try {
        const wData = await fetchWeather(city);
        const aqiVal = await fetchAQI(wData.coord.lat, wData.coord.lon);
        
        currentWeatherData = wData;
        currentAqiData = aqiVal;
        comparisonContext = ""; // Clear comparison context

        updateGlassUI(wData, aqiVal);
        showPage("details-page");
        
        addMsg(`I have updated the dashboard for ${wData.name}. The AQI is currently ${aqiVal}.`, "bot");

    } catch (e) { alert(e.message); }
    finally { btn.textContent = "Search Weather"; btn.disabled = false; }
};

// ================= COMPARE LOGIC =================
let cityInputs = ["New York", "London"];

function renderInputs() {
    const container = qs("compare-inputs");
    container.innerHTML = "";
    cityInputs.forEach((city, idx) => {
        const div = document.createElement("div");
        div.className = "city-input-group";
        div.innerHTML = `
            <input value="${city}" placeholder="City ${idx+1}" onchange="window.updateCityInArr(${idx}, this.value)">
            ${cityInputs.length > 2 ? `<button class="remove-btn" onclick="window.removeCityFromArr(${idx})">√ó</button>` : ''}
        `;
        container.appendChild(div);
    });
}
// Expose to global scope for inline onclicks
window.updateCityInArr = (i, val) => cityInputs[i] = val;
window.removeCityFromArr = (i) => { cityInputs.splice(i, 1); renderInputs(); };

qs("add-city-btn").onclick = () => {
    if(cityInputs.length < 5) { cityInputs.push(""); renderInputs(); }
    else { alert("Max 5 cities allowed."); }
};

qs("compare-btn").onclick = async () => {
    const citiesToCompare = cityInputs.filter(c => c.trim() !== "");
    if (citiesToCompare.length < 2) return alert("Need at least 2 cities");

    const btn = qs("compare-btn");
    btn.textContent = "Comparing..."; btn.disabled = true;
    qs("compare-results").innerHTML = '<div style="text-align:center">Loading data...</div>';

    try {
        const results = await Promise.all(citiesToCompare.map(async (city) => {
            try {
                const w = await fetchWeather(city);
                const aqi = await fetchAQI(w.coord.lat, w.coord.lon);
                return { city: w.name, aqi };
            } catch { return { city, error: true }; }
        }));

        const validResults = results.filter(r => !r.error).sort((a, b) => a.aqi - b.aqi);
        
        qs("compare-results").innerHTML = "";
        validResults.forEach(r => {
            const { label, classSuffix } = getAqiInfo(r.aqi);
            const el = document.createElement("div");
            el.className = `aqi-result-card aqi-${classSuffix}`;
            el.innerHTML = `
                <div class="aqi-city-name">${r.city}</div>
                <div class="aqi-score-box">
                    <div class="aqi-val">${r.aqi}</div>
                    <div class="aqi-status-label">${label}</div>
                </div>
            `;
            qs("compare-results").appendChild(el);
        });

        // Update context for chatbot
        currentWeatherData = null;
        comparisonContext = `Comparison ranking (best to worst AQI): ${validResults.map(r => `${r.city} (${r.aqi})`).join(", ")}.`;
        addMsg(`Comparison complete! ${validResults[0].city} has the cleanest air among them.`, "bot");

    } catch (e) { qs("compare-results").innerHTML = "Error fetching data."; }
    finally { btn.textContent = "Compare Now"; btn.disabled = false; }
};


// ================= API & CALC HELPERS =================
async function fetchWeather(city) {
    const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${OWM_API_KEY}&units=metric`);
    if (!res.ok) throw new Error("City found not found");
    return await res.json();
}

async function fetchAQI(lat, lon) {
    const res = await fetch(`https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${OWM_API_KEY}`);
    const data = await res.json();
    // Use PM2.5 to calculate US AQI approximation
    return calculateUSAQI(data.list[0].components.pm2_5);
}

// Simplified US AQI Calculation formula based on PM2.5 concentration
function calculateUSAQI(pm25) {
    const c = (h, l, ch, cl) => Math.round(((h - l) / (ch - cl)) * (pm25 - cl) + l);
    if (pm25 <= 12.0) return c(50, 0, 12.0, 0);
    if (pm25 <= 35.4) return c(100, 51, 35.4, 12.1);
    if (pm25 <= 55.4) return c(150, 101, 55.4, 35.5);
    if (pm25 <= 150.4) return c(200, 151, 150.4, 55.5);
    if (pm25 <= 250.4) return c(300, 201, 250.4, 150.5);
    return pm25 > 250.4 ? 301 : 200; // Cap at hazardous threshold for simplicity
}

function getAqiInfo(aqi) {
    if (aqi <= 50) return { label: "Good", color: "#00e400", classSuffix: "good" };
    if (aqi <= 100) return { label: "Moderate", color: "#ffff00", classSuffix: "mod" };
    if (aqi <= 150) return { label: "Unhealthy for Sensitive", color: "#ff7e00", classSuffix: "sens" };
    if (aqi <= 200) return { label: "Unhealthy", color: "#ff0000", classSuffix: "unhealthy" };
    if (aqi <= 300) return { label: "Very Unhealthy", color: "#8f3f97", classSuffix: "very" };
    return { label: "Hazardous", color: "#7e0023", classSuffix: "haz" };
}

// ================= UI UPDATER (NEW GLASS UI) =================
function updateGlassUI(w, aqi) {
    // Header
    qs("city-name").textContent = w.name + ", " + w.sys.country;
    qs("weather-desc-main").textContent = w.weather[0].description;

    // Card 1: Temp
    qs("temp-val").textContent = Math.round(w.main.temp);

    // Card 2: Feels Like
    qs("feels-val").textContent = Math.round(w.main.feels_like);

    // Card 3: Wind & Compass
    const speedKmh = (w.wind.speed * 3.6).toFixed(1); // Convert m/s to km/h
    qs("wind-speed").textContent = speedKmh;
    const deg = w.wind.deg || 0;
    qs("wind-arrow").style.transform = `translate(-50%, -100%) rotate(${deg}deg)`;
    const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
    const dirText = directions[Math.round(deg / 45) % 8];
    qs("wind-dir-text").textContent = `From the ${dirText}`;

    // Card 4: Humidity Gauge
    qs("humidity-val").textContent = w.main.humidity;
    // Circumference is ~163. Offset = 163 - (163 * percentage)
    const humOffset = 163 - (163 * (w.main.humidity / 100));
    qs("humidity-gauge-fill").style.strokeDashoffset = humOffset;

    // Card 5: AQI Gauge & Status
    qs("aqi-val").textContent = aqi;
    const aqiInfo = getAqiInfo(aqi);
    qs("aqi-status-text").textContent = aqiInfo.label;
    qs("aqi-status-text").style.color = aqiInfo.color;
    
    const aqiFill = qs("aqi-gauge-fill");
    aqiFill.style.stroke = aqiInfo.color; // Set gauge color dynamically
    // Scale AQI to 0-300 range for gauge percentage (cap at 100%)
    const aqiPercent = Math.min(aqi / 300, 1);
    const aqiOffset = 163 - (163 * aqiPercent);
    aqiFill.style.strokeDashoffset = aqiOffset;

    // Card 6: Visibility
    qs("visibility-val").textContent = (w.visibility / 1000).toFixed(1);

    // Card 7: Pressure
    qs("pressure-val").textContent = w.main.pressure;
}


// ================= NAV & CHATBOT =================
qs("btn-goto-compare").onclick = () => { showPage("compare-page"); renderInputs(); };
qs("back-home-btn").onclick = () => showPage("home-page");
qs("back-compare-btn").onclick = () => showPage("home-page");

qs("chat-send").onclick = handleChat;
qs("chat-input").addEventListener("keypress", (e) => { if(e.key==="Enter") handleChat(); });

async function handleChat() {
    const input = qs("chat-input");
    const msg = input.value.trim();
    if (!msg) return;
    
    if(GEMINI_API_KEY.includes("YOUR_GEMINI")) return alert("Please set Gemini API Key in code.");

    addMsg(msg, "user");
    input.value = ""; input.disabled = true;

    let promptContext = "";
    if (comparisonContext) {
        promptContext = `Context: The user is looking at AQI comparison results: ${comparisonContext}`;
    } else if (currentWeatherData) {
        promptContext = `Context: Current weather for ${currentWeatherData.name} is ${currentWeatherData.main.temp}¬∞C, ${currentWeatherData.weather[0].description}. Humidity is ${currentWeatherData.main.humidity}%. AQI is ${currentAqiData} (${getAqiInfo(currentAqiData).label}). Wind is ${currentWeatherData.wind.speed} m/s towards ${currentWeatherData.wind.deg} degrees.`;
    } else {
        promptContext = "Context: The user has not searched for any city yet.";
    }

    const fullPrompt = `You are a helpful weather and air quality assistant.
    ${promptContext}
    User Question: "${msg}"
    Answer clearly and concisely based on the context provided if applicable. Keep it under 50 words.`;

    try {
        const result = await model.generateContent(fullPrompt);
        addMsg(result.response.text(), "bot");
    } catch (e) { addMsg("Sorry, AI service is unavailable right now.", "bot"); console.log(e); }
    finally { input.disabled = false; input.focus(); }
}

function addMsg(text, type) {
    const div = document.createElement("div");
    div.className = `chat-msg ${type}-msg`;
    div.textContent = text;
    qs("chat-body").appendChild(div);
    qs("chat-body").scrollTop = qs("chat-body").scrollHeight;
}
</script>
</body>
</html>
